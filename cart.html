<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ğŸ›’</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 {
      color: #4CAF50;
      text-align: center;
    }
    .cart-items {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
      align-items: center;
    }
    .item-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .item-quantity {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .quantity-btn {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
    }
    .total {
      font-weight: bold;
      text-align: left;
      margin-top: 10px;
    }
    form {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    form input, form textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      font-size: 16px;
    }
    button:hover {
      background-color: #388E3C;
    }
    .empty-cart {
      text-align: center;
      padding: 20px;
      color: #777;
    }
    .back-btn {
      background-color: #f44336;
      margin-bottom: 15px;
    }
    .back-btn:hover {
      background-color: #d32f2f;
    }
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    .edit-btn {
      background-color: #2196F3;
      padding: 5px 10px;
      font-size: 14px;
      width: auto;
    }
    .edit-btn:hover {
      background-color: #0b7dda;
    }
    .remove-btn {
      background-color: #f44336;
      padding: 5px 10px;
      font-size: 14px;
      width: auto;
    }
    .remove-btn:hover {
      background-color: #d32f2f;
    }
    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .quantity-input {
      width: 40px;
      text-align: center;
      padding: 5px;
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="window.location.href='index.html'">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø±</button>
  <h1>Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ğŸ›’</h1>
  
  <div class="cart-items" id="cartItems">
    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
  </div>
  
  <form id="checkoutForm">
    <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
    <input type="text" id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
    <input type="tel" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required>
    <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <textarea id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„" required></textarea>
    
    <button type="submit" id="checkoutBtn">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</button>
  </form>

  <script>
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    function loadCart() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const cartItemsEl = document.getElementById('cartItems');
      
      if (cart.length === 0) {
        cartItemsEl.innerHTML = '<div class="empty-cart">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©</div>';
        return { items: [], total: 0, points: 0 };
      }

      // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¹Ø±
      const groupedItems = {};
      cart.forEach(item => {
        const key = `${item.name}_${item.price}`;
        if (!groupedItems[key]) {
          groupedItems[key] = { ...item, quantity: 1 };
        } else {
          groupedItems[key].quantity++;
        }
      });

      const groupedItemsArray = Object.values(groupedItems);

      let html = '';
      let total = 0;
      let points = 0;

      groupedItemsArray.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        points += Math.floor(itemTotal / 1000);

        html += `
          <div class="cart-item" data-id="${item.id}" data-name="${item.name}" data-price="${item.price}">
            <div class="item-info">
              <span>${item.name}</span>
            </div>
            <div class="item-quantity">
              <span class="quantity-display">${item.quantity} Ã— ${item.price} Ø¯Ø¬</span>
              <div class="quantity-controls" style="display:none;">
                <button class="quantity-btn minus-btn">-</button>
                <input type="number" class="quantity-input" value="${item.quantity}" min="1">
                <button class="quantity-btn plus-btn">+</button>
              </div>
            </div>
            <div class="item-total">${itemTotal} Ø¯Ø¬</div>
            <div class="action-buttons">
              <button class="edit-btn">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="remove-btn">Ø­Ø°Ù</button>
            </div>
          </div>
        `;
      });

      html += `<div class="total">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total} Ø¯Ø¬</div>`;
      cartItemsEl.innerHTML = html;

      // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù
      setupItemControls();

      return { items: groupedItemsArray, total, points };
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø¹Ù†Ø§ØµØ±
    function setupItemControls() {
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          const itemElement = this.closest('.cart-item');
          const displayElement = itemElement.querySelector('.quantity-display');
          const controlsElement = itemElement.querySelector('.quantity-controls');
          
          if (controlsElement.style.display === 'none') {
            controlsElement.style.display = 'flex';
            displayElement.style.display = 'none';
            this.textContent = 'Ø­ÙØ¸';
          } else {
            const newQuantity = parseInt(itemElement.querySelector('.quantity-input').value);
            if (newQuantity > 0) {
              updateCartItem(
                itemElement.dataset.id,
                itemElement.dataset.name,
                parseFloat(itemElement.dataset.price),
                newQuantity
              );
              controlsElement.style.display = 'none';
              displayElement.style.display = 'inline';
              displayElement.textContent = `${newQuantity} Ã— ${itemElement.dataset.price} Ø¯Ø¬`;
              this.textContent = 'ØªØ¹Ø¯ÙŠÙ„';
              // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
              const itemTotal = newQuantity * parseFloat(itemElement.dataset.price);
              itemElement.querySelector('.item-total').textContent = `${itemTotal} Ø¯Ø¬`;
              // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ
              updateTotal();
            } else {
              alert('Ø§Ù„ÙƒÙ…ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 1');
            }
          }
        });
      });

      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const itemElement = this.closest('.cart-item');
          if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ø³Ù„Ø©ØŸ')) {
            removeCartItem(
              itemElement.dataset.id,
              itemElement.dataset.name,
              parseFloat(itemElement.dataset.price)
            );
            itemElement.remove();
            updateTotal();
          }
        });
      });

      document.querySelectorAll('.plus-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const input = this.parentElement.querySelector('.quantity-input');
          input.value = parseInt(input.value) + 1;
        });
      });

      document.querySelectorAll('.minus-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const input = this.parentElement.querySelector('.quantity-input');
          if (parseInt(input.value) > 1) {
            input.value = parseInt(input.value) - 1;
          }
        });
      });
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ø³Ù„Ø©
    function updateCartItem(id, name, price, newQuantity) {
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      
      // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
      cart = cart.filter(item => !(item.id === id && item.name === name && item.price === price));
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
      for (let i = 0; i < newQuantity; i++) {
        cart.push({ id, name, price });
      }
      
      localStorage.setItem('cart', JSON.stringify(cart));
    }

    // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ø³Ù„Ø©
    function removeCartItem(id, name, price) {
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      cart = cart.filter(item => !(item.id === id && item.name === name && item.price === price));
      localStorage.setItem('cart', JSON.stringify(cart));
      
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©ØŒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©
      if (cart.length === 0) {
        document.getElementById('cartItems').innerHTML = '<div class="empty-cart">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©</div>';
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ
    function updateTotal() {
      const cartItems = document.querySelectorAll('.cart-item:not(.total)');
      let total = 0;
      
      cartItems.forEach(item => {
        const price = parseFloat(item.dataset.price);
        const quantity = parseInt(item.querySelector('.quantity-display').textContent);
        total += price * quantity;
      });
      
      document.querySelector('.total').textContent = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total} Ø¯Ø¬`;
    }

    // ØªÙ†ÙÙŠØ° Ø¹Ù†Ø¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
    document.getElementById('checkoutForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const cartData = loadCart();
      if (cartData.items.length === 0) {
        alert('Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©!');
        return;
      }

      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      const address = document.getElementById('address').value.trim();

      if (!name || !phone || !address) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
      }

      const order = {
        id: Date.now().toString(),
        name,
        phone,
        email: email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
        address,
        items: cartData.items,
        total: cartData.total,
        points: cartData.points,
        date: new Date().toISOString()
      };

      // Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ localStorage
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      orders.push(order);
      localStorage.setItem('orders', JSON.stringify(orders));

      // ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø· Ø§Ù„Ø²Ø¨ÙˆÙ†
      updateUserPoints(name, phone, email, address, cartData.points);

      // ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©
      localStorage.removeItem('cart');

      alert('ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø´ÙƒØ±Ø§Ù‹ Ù„Ø´Ø±Ø§Ø¦Ùƒ Ù…Ø¹Ù†Ø§.');
      window.location.href = 'index.html';
    });

    // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø·Ù‡
    function updateUserPoints(name, phone, email, address, pointsToAdd) {
      const userData = JSON.parse(localStorage.getItem('user_data')) || {};
      userData[name] = { name, phone, email, address };
      localStorage.setItem('user_data', JSON.stringify(userData));

      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const pointsKey = `user_points_${year}_${month}`;

      const monthlyPoints = JSON.parse(localStorage.getItem(pointsKey)) || {};
      monthlyPoints[name] = (monthlyPoints[name] || 0) + pointsToAdd;
      localStorage.setItem(pointsKey, JSON.stringify(monthlyPoints));
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù„Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    loadCart();
  </script>
</body>
</html>